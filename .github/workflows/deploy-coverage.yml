name: Deploy Coverage Report

on:
  push:
    branches: [ main ]

jobs:
  deploy-coverage:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Dart SDK
        uses: dart-lang/setup-dart@v1
        with:
          sdk: 'stable'

      - name: Install dependencies
        run: dart pub get

      - name: Generate coverage report
        run: |
          # Run tests with coverage
          dart test --coverage=coverage/
          dart pub global activate coverage
          dart pub global run coverage:format_coverage \
            --lcov \
            --in=coverage/ \
            --out=coverage/lcov.info \
            --packages=.dart_tool/package_config.json \
            --report-on=lib
          
          # Install lcov and generate HTML report
          sudo apt-get update
          sudo apt-get install -y lcov
          genhtml coverage/lcov.info -o coverage/html/
          
          # Create index page
          cat > coverage/html/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>MusicXML Parser - Test Coverage Report</title>
              <meta charset="utf-8">
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 40px; }
                  .header { background: #f6f8fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                  .stats { display: flex; gap: 20px; margin: 20px 0; }
                  .stat { background: white; padding: 15px; border-radius: 6px; border: 1px solid #d1d5da; }
                  .coverage-high { color: #28a745; }
                  .coverage-medium { color: #ffc107; }
                  .coverage-low { color: #dc3545; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>ğŸµ MusicXML Parser - Test Coverage Report</h1>
                  <p>Generated on $(date)</p>
              </div>
              
              <div class="stats">
                  <div class="stat">
                      <h3>ğŸ“Š Overall Coverage</h3>
                      <p id="coverage-percent" class="coverage-high">Loading...</p>
                  </div>
                  <div class="stat">
                      <h3>ğŸ§ª Test Files</h3>
                      <p>$(find test -name "*.dart" | wc -l) test files</p>
                  </div>
                  <div class="stat">
                      <h3>ğŸ“ Source Files</h3>
                      <p>$(find lib -name "*.dart" | wc -l) source files</p>
                  </div>
              </div>
              
              <h2>ğŸ“‹ Detailed Coverage Report</h2>
              <p><a href="./index.html">View Detailed LCOV Report â†’</a></p>
              
              <script>
                  // Extract coverage from LCOV summary and update display
                  fetch('./index.html')
                      .then(response => response.text())
                      .then(html => {
                          const parser = new DOMParser();
                          const doc = parser.parseFromString(html, 'text/html');
                          const coverageElement = doc.querySelector('td.headerCovTableEntryHi, td.headerCovTableEntryMed, td.headerCovTableEntryLo');
                          if (coverageElement) {
                              const coverage = coverageElement.textContent.trim();
                              document.getElementById('coverage-percent').textContent = coverage;
                          }
                      })
                      .catch(() => {
                          document.getElementById('coverage-percent').textContent = 'Report not available';
                      });
              </script>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./coverage/html
          destination_dir: coverage
